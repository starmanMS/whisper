<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆæ¯å‘é€åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.error { color: #dc3545; }
        .log-entry.success { color: #28a745; }
        .log-entry.info { color: #17a2b8; }
        .log-entry.warning { color: #ffc107; }
        .test-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .widget-container {
            position: relative;
            height: 500px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ§ª æ¶ˆæ¯å‘é€åŠŸèƒ½æµ‹è¯•</h1>
            <p>ä¸“é—¨ç”¨äºæµ‹è¯•å’Œè°ƒè¯•èŠå¤©Widgetçš„æ¶ˆæ¯å‘é€åŠŸèƒ½</p>
        </div>

        <!-- åˆå§‹åŒ–æµ‹è¯• -->
        <div class="test-section">
            <h3>1. Widgetåˆå§‹åŒ–</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="initializeWidget()">åˆå§‹åŒ–Widget</button>
                <button class="btn btn-warning" onclick="openChat()">æ‰“å¼€èŠå¤©</button>
                <button class="btn btn-danger" onclick="destroyWidget()">é”€æ¯Widget</button>
            </div>
            <div id="initStatus" class="status info">ç­‰å¾…åˆå§‹åŒ–...</div>
        </div>

        <!-- æ¶ˆæ¯å‘é€æµ‹è¯• -->
        <div class="test-section">
            <h3>2. æ¶ˆæ¯å‘é€æµ‹è¯•</h3>
            <input type="text" id="testMessage" class="test-input" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..." value="è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯">
            <div class="button-group">
                <button class="btn btn-success" onclick="sendTestMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
                <button class="btn btn-primary" onclick="sendMultipleMessages()">å‘é€å¤šæ¡æ¶ˆæ¯</button>
                <button class="btn btn-warning" onclick="sendEmptyMessage()">å‘é€ç©ºæ¶ˆæ¯</button>
                <button class="btn btn-danger" onclick="sendLongMessage()">å‘é€é•¿æ¶ˆæ¯</button>
            </div>
            <div id="sendStatus" class="status info">ç­‰å¾…å‘é€...</div>
        </div>

        <!-- äº‹ä»¶ç›‘å¬æµ‹è¯• -->
        <div class="test-section">
            <h3>3. äº‹ä»¶ç›‘å¬æµ‹è¯•</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="startEventListening()">å¼€å§‹ç›‘å¬äº‹ä»¶</button>
                <button class="btn btn-warning" onclick="stopEventListening()">åœæ­¢ç›‘å¬</button>
                <button class="btn btn-success" onclick="triggerManualSend()">æ‰‹åŠ¨è§¦å‘å‘é€</button>
            </div>
            <div id="eventStatus" class="status info">äº‹ä»¶ç›‘å¬æœªå¯åŠ¨</div>
        </div>

        <!-- Widgetæ˜¾ç¤ºåŒºåŸŸ -->
        <div class="test-section">
            <h3>4. Widgetæ˜¾ç¤ºåŒºåŸŸ</h3>
            <div class="widget-container" id="widgetContainer">
                Widgetå°†åœ¨è¿™é‡Œæ˜¾ç¤º
            </div>
        </div>

        <!-- è°ƒè¯•æ—¥å¿— -->
        <div class="test-section">
            <h3>5. è°ƒè¯•æ—¥å¿—</h3>
            <div class="button-group">
                <button class="btn btn-warning" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                <button class="btn btn-primary" onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
            </div>
            <div id="debugLogs" class="log-container">
                <div class="log-entry info">æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œç­‰å¾…æ“ä½œ...</div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½Widgetè„šæœ¬ -->
    <script src="./dist/whisper-chat-widget.js"></script>

    <script>
        let widgetInitialized = false;
        let eventListening = false;
        let chatInstance = null;

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById('debugLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            console.log(`%c[${type.toUpperCase()}] ${message}`, getLogStyle(type));
        }

        function getLogStyle(type) {
            const styles = {
                info: 'color: #17a2b8;',
                success: 'color: #28a745; font-weight: bold;',
                error: 'color: #dc3545; font-weight: bold;',
                warning: 'color: #ffc107; font-weight: bold;'
            };
            return styles[type] || styles.info;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            addLog(`${elementId}: ${message}`, type);
        }

        // åˆå§‹åŒ–Widget
        function initializeWidget() {
            try {
                if (typeof WhisperChat === 'undefined') {
                    updateStatus('initStatus', 'âŒ WhisperChatæœªåŠ è½½', 'error');
                    return;
                }

                const config = {
                    apiUrl: 'http://localhost:8080',
                    websocketUrl: 'ws://localhost:8080/websocket',
                    customerId: `test_${Date.now()}`,
                    customerName: 'æ¶ˆæ¯æµ‹è¯•ç”¨æˆ·',
                    theme: 'light',
                    position: 'bottom-right'
                };

                addLog('å¼€å§‹åˆå§‹åŒ–Widget...');
                addLog('é…ç½®: ' + JSON.stringify(config, null, 2));

                WhisperChat.init(config);
                widgetInitialized = true;
                chatInstance = WhisperChat;
                
                updateStatus('initStatus', 'âœ… Widgetåˆå§‹åŒ–æˆåŠŸ', 'success');

                // ç›‘å¬Widgetå†…éƒ¨äº‹ä»¶
                if (eventListening) {
                    startEventListening();
                }

            } catch (error) {
                updateStatus('initStatus', `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                addLog(`åˆå§‹åŒ–é”™è¯¯: ${error.stack}`, 'error');
            }
        }

        // æ‰“å¼€èŠå¤©
        function openChat() {
            if (!widgetInitialized) {
                updateStatus('initStatus', 'âš ï¸ è¯·å…ˆåˆå§‹åŒ–Widget', 'warning');
                return;
            }

            try {
                if (WhisperChat.open) {
                    WhisperChat.open();
                    addLog('èŠå¤©çª—å£å·²æ‰“å¼€', 'success');
                } else {
                    addLog('openæ–¹æ³•ä¸å¯ç”¨', 'warning');
                }
            } catch (error) {
                addLog(`æ‰“å¼€èŠå¤©å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é”€æ¯Widget
        function destroyWidget() {
            try {
                if (WhisperChat.destroy) {
                    WhisperChat.destroy();
                    widgetInitialized = false;
                    updateStatus('initStatus', 'âœ… Widgetå·²é”€æ¯', 'success');
                } else {
                    addLog('destroyæ–¹æ³•ä¸å¯ç”¨', 'warning');
                }
            } catch (error) {
                addLog(`é”€æ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å‘é€æµ‹è¯•æ¶ˆæ¯
        function sendTestMessage() {
            const message = document.getElementById('testMessage').value;
            if (!message.trim()) {
                updateStatus('sendStatus', 'âš ï¸ è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'warning');
                return;
            }

            addLog(`å‡†å¤‡å‘é€æ¶ˆæ¯: "${message}"`);
            
            // æ¨¡æ‹Ÿç‚¹å‡»å‘é€æŒ‰é’®
            simulateMessageSend(message);
        }

        // å‘é€å¤šæ¡æ¶ˆæ¯
        function sendMultipleMessages() {
            const messages = [
                'ç¬¬ä¸€æ¡æµ‹è¯•æ¶ˆæ¯',
                'ç¬¬äºŒæ¡æµ‹è¯•æ¶ˆæ¯',
                'ç¬¬ä¸‰æ¡æµ‹è¯•æ¶ˆæ¯'
            ];

            messages.forEach((msg, index) => {
                setTimeout(() => {
                    addLog(`å‘é€ç¬¬${index + 1}æ¡æ¶ˆæ¯: "${msg}"`);
                    simulateMessageSend(msg);
                }, index * 1000);
            });
        }

        // å‘é€ç©ºæ¶ˆæ¯
        function sendEmptyMessage() {
            addLog('å°è¯•å‘é€ç©ºæ¶ˆæ¯');
            simulateMessageSend('');
        }

        // å‘é€é•¿æ¶ˆæ¯
        function sendLongMessage() {
            const longMessage = 'è¿™æ˜¯ä¸€æ¡å¾ˆé•¿çš„æµ‹è¯•æ¶ˆæ¯ï¼Œ'.repeat(20) + 'ç”¨äºæµ‹è¯•é•¿æ–‡æœ¬çš„å¤„ç†èƒ½åŠ›ã€‚';
            addLog(`å‘é€é•¿æ¶ˆæ¯ (${longMessage.length} å­—ç¬¦)`);
            simulateMessageSend(longMessage);
        }

        // æ¨¡æ‹Ÿæ¶ˆæ¯å‘é€
        function simulateMessageSend(message) {
            try {
                // æŸ¥æ‰¾æ¶ˆæ¯è¾“å…¥æ¡†
                const messageInput = document.querySelector('.whisper-chat-text-input');
                const sendButton = document.querySelector('.whisper-chat-send-button');

                if (!messageInput || !sendButton) {
                    addLog('æœªæ‰¾åˆ°æ¶ˆæ¯è¾“å…¥æ¡†æˆ–å‘é€æŒ‰é’®', 'error');
                    updateStatus('sendStatus', 'âŒ æœªæ‰¾åˆ°è¾“å…¥ç»„ä»¶', 'error');
                    return;
                }

                // è®¾ç½®æ¶ˆæ¯å†…å®¹
                messageInput.value = message;
                messageInput.dispatchEvent(new Event('input', { bubbles: true }));

                addLog('å·²è®¾ç½®æ¶ˆæ¯å†…å®¹ï¼Œå‡†å¤‡ç‚¹å‡»å‘é€æŒ‰é’®');

                // ç‚¹å‡»å‘é€æŒ‰é’®
                sendButton.click();

                updateStatus('sendStatus', 'âœ… å·²è§¦å‘å‘é€', 'success');

            } catch (error) {
                addLog(`æ¨¡æ‹Ÿå‘é€å¤±è´¥: ${error.message}`, 'error');
                updateStatus('sendStatus', `âŒ å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¼€å§‹äº‹ä»¶ç›‘å¬
        function startEventListening() {
            eventListening = true;
            updateStatus('eventStatus', 'âœ… äº‹ä»¶ç›‘å¬å·²å¯åŠ¨', 'success');

            // ç›‘å¬DOMå˜åŒ–
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                if (node.classList && node.classList.contains('whisper-chat-message')) {
                                    addLog('æ£€æµ‹åˆ°æ–°æ¶ˆæ¯å…ƒç´ ', 'info');
                                }
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            addLog('DOMå˜åŒ–ç›‘å¬å·²å¯åŠ¨', 'info');
        }

        // åœæ­¢äº‹ä»¶ç›‘å¬
        function stopEventListening() {
            eventListening = false;
            updateStatus('eventStatus', 'â¹ï¸ äº‹ä»¶ç›‘å¬å·²åœæ­¢', 'warning');
        }

        // æ‰‹åŠ¨è§¦å‘å‘é€
        function triggerManualSend() {
            addLog('æ‰‹åŠ¨è§¦å‘æ¶ˆæ¯å‘é€äº‹ä»¶');
            
            // åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶
            const sendEvent = new CustomEvent('whisper-send-message', {
                detail: {
                    content: 'æ‰‹åŠ¨è§¦å‘çš„æµ‹è¯•æ¶ˆæ¯',
                    type: 'text',
                    timestamp: Date.now()
                }
            });

            document.dispatchEvent(sendEvent);
            addLog('å·²æ´¾å‘è‡ªå®šä¹‰å‘é€äº‹ä»¶', 'info');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('debugLogs').innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            const logs = document.getElementById('debugLogs').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `whisper-chat-logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addLog('æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // ç›‘å¬å…¨å±€é”™è¯¯
        window.addEventListener('error', function(event) {
            addLog(`å…¨å±€é”™è¯¯: ${event.error.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            addLog(`æœªå¤„ç†çš„Promiseé”™è¯¯: ${event.reason}`, 'error');
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            addLog('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            addLog('è¯·æŒ‰é¡ºåºæ‰§è¡Œ: 1.åˆå§‹åŒ–Widget â†’ 2.æ‰“å¼€èŠå¤© â†’ 3.å‘é€æµ‹è¯•æ¶ˆæ¯', 'info');
        });
    </script>
</body>
</html>
