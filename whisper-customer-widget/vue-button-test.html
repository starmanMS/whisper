<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue Button Test - Whisper Widget</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }
    
    .test-title {
      font-size: 2.5rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 1rem;
      color: #1f2937;
    }
    
    .test-description {
      font-size: 1.1rem;
      color: #6b7280;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .test-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .test-button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .test-button:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .test-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-display {
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-weight: 500;
    }
    
    .status-display.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    .status-display.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #f87171;
    }
    
    .status-display.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #60a5fa;
    }
    
    .debug-panel {
      background: #1f2937;
      color: #f3f4f6;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: monospace;
      font-size: 0.875rem;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .content-area {
      height: 150vh;
      background: rgba(255,255,255,0.1);
      margin: 2rem 0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1 class="test-title">🔘 Vue 按钮测试</h1>
    <p class="test-description">
      直接测试 Vue ChatButton 组件的定位和样式
    </p>
    
    <div id="status-display" class="status-display info">
      正在初始化 Vue 组件测试...
    </div>
    
    <div class="test-controls">
      <button class="test-button" onclick="initVueButton()">初始化 Vue 按钮</button>
      <button class="test-button" onclick="togglePosition()">切换位置</button>
      <button class="test-button" onclick="toggleTheme()">切换主题</button>
      <button class="test-button" onclick="toggleConnection()">切换连接状态</button>
      <button class="test-button" onclick="addUnreadMessages()">添加未读消息</button>
      <button class="test-button" onclick="clearUnreadMessages()">清除未读消息</button>
      <button class="test-button" onclick="inspectVueButton()">检查 Vue 按钮</button>
      <button class="test-button" onclick="destroyVueButton()">销毁按钮</button>
    </div>
    
    <div id="debug-panel" class="debug-panel"></div>
  </div>
  
  <div class="content-area">
    滚动测试区域 - Vue 按钮应保持固定位置
  </div>

  <!-- Vue 按钮挂载点 -->
  <div id="vue-button-mount"></div>

  <script type="module">
    let vueApp = null;
    let buttonProps = {
      isOpen: false,
      unreadCount: 0,
      position: 'bottom-right',
      theme: 'light',
      isConnected: true,
      isConnecting: false
    };

    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status-display');
      statusDiv.className = `status-display ${type}`;
      statusDiv.textContent = message;
    }

    function addDebugLog(message) {
      const debugPanel = document.getElementById('debug-panel');
      const timestamp = new Date().toLocaleTimeString();
      debugPanel.textContent += `[${timestamp}] ${message}\n`;
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    async function initVueButton() {
      try {
        addDebugLog('开始初始化 Vue ChatButton 组件...');
        
        // 动态导入 Vue 和组件
        const { createApp, ref } = await import('http://localhost:3001/@modules/vue');
        const ChatButton = await import('http://localhost:3001/src/components/ChatButton.vue');
        
        addDebugLog('Vue 和 ChatButton 组件已加载');
        
        // 创建 Vue 应用
        vueApp = createApp({
          components: {
            ChatButton: ChatButton.default
          },
          setup() {
            const props = ref(buttonProps);
            
            const handleToggle = () => {
              addDebugLog('Vue 按钮被点击！');
              props.value.isOpen = !props.value.isOpen;
              updateStatus('✅ Vue 按钮点击事件正常工作', 'success');
            };
            
            return {
              props,
              handleToggle
            };
          },
          template: `
            <ChatButton
              :is-open="props.isOpen"
              :unread-count="props.unreadCount"
              :position="props.position"
              :theme="props.theme"
              :is-connected="props.isConnected"
              :is-connecting="props.isConnecting"
              @toggle="handleToggle"
            />
          `
        });
        
        // 挂载到指定元素
        const mountPoint = document.getElementById('vue-button-mount');
        mountPoint.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 9999;
        `;
        
        vueApp.mount(mountPoint);
        
        addDebugLog('Vue 按钮挂载成功');
        updateStatus('✅ Vue 按钮初始化成功！', 'success');
        
        // 检查按钮是否创建
        setTimeout(() => {
          inspectVueButton();
        }, 1000);
        
      } catch (error) {
        addDebugLog('初始化失败: ' + error.message);
        updateStatus('❌ 初始化失败: ' + error.message, 'error');
        console.error('Vue button initialization error:', error);
      }
    }

    function togglePosition() {
      if (!vueApp) {
        updateStatus('❌ 请先初始化 Vue 按钮', 'error');
        return;
      }
      
      buttonProps.position = buttonProps.position === 'bottom-right' ? 'bottom-left' : 'bottom-right';
      addDebugLog(`位置切换到: ${buttonProps.position}`);
      updateStatus(`✅ 位置已切换为: ${buttonProps.position}`, 'success');
    }

    function toggleTheme() {
      if (!vueApp) {
        updateStatus('❌ 请先初始化 Vue 按钮', 'error');
        return;
      }
      
      buttonProps.theme = buttonProps.theme === 'light' ? 'dark' : 'light';
      addDebugLog(`主题切换到: ${buttonProps.theme}`);
      updateStatus(`✅ 主题已切换为: ${buttonProps.theme}`, 'success');
    }

    function toggleConnection() {
      if (!vueApp) {
        updateStatus('❌ 请先初始化 Vue 按钮', 'error');
        return;
      }
      
      if (buttonProps.isConnected) {
        buttonProps.isConnected = false;
        buttonProps.isConnecting = false;
      } else if (!buttonProps.isConnecting) {
        buttonProps.isConnecting = true;
      } else {
        buttonProps.isConnected = true;
        buttonProps.isConnecting = false;
      }
      
      const status = buttonProps.isConnecting ? '连接中' : (buttonProps.isConnected ? '已连接' : '已断开');
      addDebugLog(`连接状态: ${status}`);
      updateStatus(`✅ 连接状态: ${status}`, 'success');
    }

    function addUnreadMessages() {
      if (!vueApp) {
        updateStatus('❌ 请先初始化 Vue 按钮', 'error');
        return;
      }
      
      buttonProps.unreadCount += Math.floor(Math.random() * 5) + 1;
      addDebugLog(`未读消息数: ${buttonProps.unreadCount}`);
      updateStatus(`✅ 未读消息数: ${buttonProps.unreadCount}`, 'success');
    }

    function clearUnreadMessages() {
      if (!vueApp) {
        updateStatus('❌ 请先初始化 Vue 按钮', 'error');
        return;
      }
      
      buttonProps.unreadCount = 0;
      addDebugLog('已清除未读消息');
      updateStatus('✅ 已清除未读消息', 'success');
    }

    function inspectVueButton() {
      addDebugLog('=== 检查 Vue 按钮元素 ===');
      
      const button = document.querySelector('.whisper-chat-button');
      if (!button) {
        addDebugLog('❌ 未找到 Vue 聊天按钮元素');
        updateStatus('❌ 未找到 Vue 聊天按钮', 'error');
        return;
      }
      
      addDebugLog('✅ 找到 Vue 聊天按钮元素');
      
      // 检查样式
      const styles = window.getComputedStyle(button);
      addDebugLog(`元素类型: ${button.tagName}`);
      addDebugLog(`位置: ${styles.position}`);
      addDebugLog(`z-index: ${styles.zIndex}`);
      addDebugLog(`bottom: ${styles.bottom}`);
      addDebugLog(`right: ${styles.right}`);
      addDebugLog(`left: ${styles.left}`);
      addDebugLog(`width: ${styles.width}`);
      addDebugLog(`height: ${styles.height}`);
      addDebugLog(`background: ${styles.background}`);
      addDebugLog(`border-radius: ${styles.borderRadius}`);
      addDebugLog(`pointer-events: ${styles.pointerEvents}`);
      
      // 检查类名
      addDebugLog(`类名: ${button.className}`);
      
      // 检查位置
      const rect = button.getBoundingClientRect();
      addDebugLog(`实际位置: top=${Math.round(rect.top)}, left=${Math.round(rect.left)}, right=${Math.round(rect.right)}, bottom=${Math.round(rect.bottom)}`);
      addDebugLog(`视口位置: bottom=${Math.round(window.innerHeight - rect.bottom)}, right=${Math.round(window.innerWidth - rect.right)}`);
      
      updateStatus('✅ Vue 按钮检查完成，查看调试面板', 'success');
    }

    function destroyVueButton() {
      if (vueApp) {
        vueApp.unmount();
        vueApp = null;
        addDebugLog('Vue 按钮已销毁');
        updateStatus('✅ Vue 按钮已销毁', 'info');
      } else {
        updateStatus('❌ 没有 Vue 按钮可销毁', 'error');
      }
    }

    // 页面加载完成后的初始化
    window.addEventListener('load', () => {
      addDebugLog('Vue 按钮测试页面已加载');
      updateStatus('🔄 页面已加载，点击"初始化 Vue 按钮"开始测试', 'info');
    });

    // 监听窗口大小变化
    window.addEventListener('resize', () => {
      addDebugLog(`窗口大小变化: ${window.innerWidth}x${window.innerHeight}`);
    });

    // 暴露函数到全局作用域
    window.initVueButton = initVueButton;
    window.togglePosition = togglePosition;
    window.toggleTheme = toggleTheme;
    window.toggleConnection = toggleConnection;
    window.addUnreadMessages = addUnreadMessages;
    window.clearUnreadMessages = clearUnreadMessages;
    window.inspectVueButton = inspectVueButton;
    window.destroyVueButton = destroyVueButton;
  </script>
</body>
</html>
