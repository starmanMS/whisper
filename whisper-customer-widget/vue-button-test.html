<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue Button Test - Whisper Widget</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }
    
    .test-title {
      font-size: 2.5rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 1rem;
      color: #1f2937;
    }
    
    .test-description {
      font-size: 1.1rem;
      color: #6b7280;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .test-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .test-button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .test-button:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .test-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-display {
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-weight: 500;
    }
    
    .status-display.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    .status-display.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #f87171;
    }
    
    .status-display.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #60a5fa;
    }
    
    .debug-panel {
      background: #1f2937;
      color: #f3f4f6;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: monospace;
      font-size: 0.875rem;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .content-area {
      height: 150vh;
      background: rgba(255,255,255,0.1);
      margin: 2rem 0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1 class="test-title">ğŸ”˜ Vue æŒ‰é’®æµ‹è¯•</h1>
    <p class="test-description">
      ç›´æ¥æµ‹è¯• Vue ChatButton ç»„ä»¶çš„å®šä½å’Œæ ·å¼
    </p>
    
    <div id="status-display" class="status-display info">
      æ­£åœ¨åˆå§‹åŒ– Vue ç»„ä»¶æµ‹è¯•...
    </div>
    
    <div class="test-controls">
      <button class="test-button" onclick="initVueButton()">åˆå§‹åŒ– Vue æŒ‰é’®</button>
      <button class="test-button" onclick="togglePosition()">åˆ‡æ¢ä½ç½®</button>
      <button class="test-button" onclick="toggleTheme()">åˆ‡æ¢ä¸»é¢˜</button>
      <button class="test-button" onclick="toggleConnection()">åˆ‡æ¢è¿æ¥çŠ¶æ€</button>
      <button class="test-button" onclick="addUnreadMessages()">æ·»åŠ æœªè¯»æ¶ˆæ¯</button>
      <button class="test-button" onclick="clearUnreadMessages()">æ¸…é™¤æœªè¯»æ¶ˆæ¯</button>
      <button class="test-button" onclick="inspectVueButton()">æ£€æŸ¥ Vue æŒ‰é’®</button>
      <button class="test-button" onclick="destroyVueButton()">é”€æ¯æŒ‰é’®</button>
    </div>
    
    <div id="debug-panel" class="debug-panel"></div>
  </div>
  
  <div class="content-area">
    æ»šåŠ¨æµ‹è¯•åŒºåŸŸ - Vue æŒ‰é’®åº”ä¿æŒå›ºå®šä½ç½®
  </div>

  <!-- Vue æŒ‰é’®æŒ‚è½½ç‚¹ -->
  <div id="vue-button-mount"></div>

  <script type="module">
    let vueApp = null;
    let buttonProps = {
      isOpen: false,
      unreadCount: 0,
      position: 'bottom-right',
      theme: 'light',
      isConnected: true,
      isConnecting: false
    };

    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status-display');
      statusDiv.className = `status-display ${type}`;
      statusDiv.textContent = message;
    }

    function addDebugLog(message) {
      const debugPanel = document.getElementById('debug-panel');
      const timestamp = new Date().toLocaleTimeString();
      debugPanel.textContent += `[${timestamp}] ${message}\n`;
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    async function initVueButton() {
      try {
        addDebugLog('å¼€å§‹åˆå§‹åŒ– Vue ChatButton ç»„ä»¶...');
        
        // åŠ¨æ€å¯¼å…¥ Vue å’Œç»„ä»¶
        const { createApp, ref } = await import('http://localhost:3001/@modules/vue');
        const ChatButton = await import('http://localhost:3001/src/components/ChatButton.vue');
        
        addDebugLog('Vue å’Œ ChatButton ç»„ä»¶å·²åŠ è½½');
        
        // åˆ›å»º Vue åº”ç”¨
        vueApp = createApp({
          components: {
            ChatButton: ChatButton.default
          },
          setup() {
            const props = ref(buttonProps);
            
            const handleToggle = () => {
              addDebugLog('Vue æŒ‰é’®è¢«ç‚¹å‡»ï¼');
              props.value.isOpen = !props.value.isOpen;
              updateStatus('âœ… Vue æŒ‰é’®ç‚¹å‡»äº‹ä»¶æ­£å¸¸å·¥ä½œ', 'success');
            };
            
            return {
              props,
              handleToggle
            };
          },
          template: `
            <ChatButton
              :is-open="props.isOpen"
              :unread-count="props.unreadCount"
              :position="props.position"
              :theme="props.theme"
              :is-connected="props.isConnected"
              :is-connecting="props.isConnecting"
              @toggle="handleToggle"
            />
          `
        });
        
        // æŒ‚è½½åˆ°æŒ‡å®šå…ƒç´ 
        const mountPoint = document.getElementById('vue-button-mount');
        mountPoint.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 9999;
        `;
        
        vueApp.mount(mountPoint);
        
        addDebugLog('Vue æŒ‰é’®æŒ‚è½½æˆåŠŸ');
        updateStatus('âœ… Vue æŒ‰é’®åˆå§‹åŒ–æˆåŠŸï¼', 'success');
        
        // æ£€æŸ¥æŒ‰é’®æ˜¯å¦åˆ›å»º
        setTimeout(() => {
          inspectVueButton();
        }, 1000);
        
      } catch (error) {
        addDebugLog('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        updateStatus('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        console.error('Vue button initialization error:', error);
      }
    }

    function togglePosition() {
      if (!vueApp) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Vue æŒ‰é’®', 'error');
        return;
      }
      
      buttonProps.position = buttonProps.position === 'bottom-right' ? 'bottom-left' : 'bottom-right';
      addDebugLog(`ä½ç½®åˆ‡æ¢åˆ°: ${buttonProps.position}`);
      updateStatus(`âœ… ä½ç½®å·²åˆ‡æ¢ä¸º: ${buttonProps.position}`, 'success');
    }

    function toggleTheme() {
      if (!vueApp) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Vue æŒ‰é’®', 'error');
        return;
      }
      
      buttonProps.theme = buttonProps.theme === 'light' ? 'dark' : 'light';
      addDebugLog(`ä¸»é¢˜åˆ‡æ¢åˆ°: ${buttonProps.theme}`);
      updateStatus(`âœ… ä¸»é¢˜å·²åˆ‡æ¢ä¸º: ${buttonProps.theme}`, 'success');
    }

    function toggleConnection() {
      if (!vueApp) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Vue æŒ‰é’®', 'error');
        return;
      }
      
      if (buttonProps.isConnected) {
        buttonProps.isConnected = false;
        buttonProps.isConnecting = false;
      } else if (!buttonProps.isConnecting) {
        buttonProps.isConnecting = true;
      } else {
        buttonProps.isConnected = true;
        buttonProps.isConnecting = false;
      }
      
      const status = buttonProps.isConnecting ? 'è¿æ¥ä¸­' : (buttonProps.isConnected ? 'å·²è¿æ¥' : 'å·²æ–­å¼€');
      addDebugLog(`è¿æ¥çŠ¶æ€: ${status}`);
      updateStatus(`âœ… è¿æ¥çŠ¶æ€: ${status}`, 'success');
    }

    function addUnreadMessages() {
      if (!vueApp) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Vue æŒ‰é’®', 'error');
        return;
      }
      
      buttonProps.unreadCount += Math.floor(Math.random() * 5) + 1;
      addDebugLog(`æœªè¯»æ¶ˆæ¯æ•°: ${buttonProps.unreadCount}`);
      updateStatus(`âœ… æœªè¯»æ¶ˆæ¯æ•°: ${buttonProps.unreadCount}`, 'success');
    }

    function clearUnreadMessages() {
      if (!vueApp) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Vue æŒ‰é’®', 'error');
        return;
      }
      
      buttonProps.unreadCount = 0;
      addDebugLog('å·²æ¸…é™¤æœªè¯»æ¶ˆæ¯');
      updateStatus('âœ… å·²æ¸…é™¤æœªè¯»æ¶ˆæ¯', 'success');
    }

    function inspectVueButton() {
      addDebugLog('=== æ£€æŸ¥ Vue æŒ‰é’®å…ƒç´  ===');
      
      const button = document.querySelector('.whisper-chat-button');
      if (!button) {
        addDebugLog('âŒ æœªæ‰¾åˆ° Vue èŠå¤©æŒ‰é’®å…ƒç´ ');
        updateStatus('âŒ æœªæ‰¾åˆ° Vue èŠå¤©æŒ‰é’®', 'error');
        return;
      }
      
      addDebugLog('âœ… æ‰¾åˆ° Vue èŠå¤©æŒ‰é’®å…ƒç´ ');
      
      // æ£€æŸ¥æ ·å¼
      const styles = window.getComputedStyle(button);
      addDebugLog(`å…ƒç´ ç±»å‹: ${button.tagName}`);
      addDebugLog(`ä½ç½®: ${styles.position}`);
      addDebugLog(`z-index: ${styles.zIndex}`);
      addDebugLog(`bottom: ${styles.bottom}`);
      addDebugLog(`right: ${styles.right}`);
      addDebugLog(`left: ${styles.left}`);
      addDebugLog(`width: ${styles.width}`);
      addDebugLog(`height: ${styles.height}`);
      addDebugLog(`background: ${styles.background}`);
      addDebugLog(`border-radius: ${styles.borderRadius}`);
      addDebugLog(`pointer-events: ${styles.pointerEvents}`);
      
      // æ£€æŸ¥ç±»å
      addDebugLog(`ç±»å: ${button.className}`);
      
      // æ£€æŸ¥ä½ç½®
      const rect = button.getBoundingClientRect();
      addDebugLog(`å®é™…ä½ç½®: top=${Math.round(rect.top)}, left=${Math.round(rect.left)}, right=${Math.round(rect.right)}, bottom=${Math.round(rect.bottom)}`);
      addDebugLog(`è§†å£ä½ç½®: bottom=${Math.round(window.innerHeight - rect.bottom)}, right=${Math.round(window.innerWidth - rect.right)}`);
      
      updateStatus('âœ… Vue æŒ‰é’®æ£€æŸ¥å®Œæˆï¼ŒæŸ¥çœ‹è°ƒè¯•é¢æ¿', 'success');
    }

    function destroyVueButton() {
      if (vueApp) {
        vueApp.unmount();
        vueApp = null;
        addDebugLog('Vue æŒ‰é’®å·²é”€æ¯');
        updateStatus('âœ… Vue æŒ‰é’®å·²é”€æ¯', 'info');
      } else {
        updateStatus('âŒ æ²¡æœ‰ Vue æŒ‰é’®å¯é”€æ¯', 'error');
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    window.addEventListener('load', () => {
      addDebugLog('Vue æŒ‰é’®æµ‹è¯•é¡µé¢å·²åŠ è½½');
      updateStatus('ğŸ”„ é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»"åˆå§‹åŒ– Vue æŒ‰é’®"å¼€å§‹æµ‹è¯•', 'info');
    });

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
      addDebugLog(`çª—å£å¤§å°å˜åŒ–: ${window.innerWidth}x${window.innerHeight}`);
    });

    // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.initVueButton = initVueButton;
    window.togglePosition = togglePosition;
    window.toggleTheme = toggleTheme;
    window.toggleConnection = toggleConnection;
    window.addUnreadMessages = addUnreadMessages;
    window.clearUnreadMessages = clearUnreadMessages;
    window.inspectVueButton = inspectVueButton;
    window.destroyVueButton = destroyVueButton;
  </script>
</body>
</html>
