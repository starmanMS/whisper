<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Button Test - Whisper Widget</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      position: relative;
    }
    
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }
    
    .test-title {
      font-size: 2.5rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 1rem;
      color: #1f2937;
    }
    
    .test-description {
      font-size: 1.1rem;
      color: #6b7280;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .test-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .test-button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .test-button:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .test-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-display {
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-weight: 500;
    }
    
    .status-display.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    .status-display.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #f87171;
    }
    
    .status-display.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #60a5fa;
    }
    
    .debug-panel {
      background: #1f2937;
      color: #f3f4f6;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: monospace;
      font-size: 0.875rem;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .test-info {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .test-info h3 {
      margin: 0 0 0.5rem 0;
      color: #374151;
    }
    
    .test-info ul {
      margin: 0;
      padding-left: 1.5rem;
    }
    
    .test-info li {
      margin: 0.25rem 0;
      color: #6b7280;
    }
    
    /* Add some content to test positioning */
    .content-area {
      height: 200vh;
      background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0.3));
      margin: 2rem 0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1 class="test-title">🔘 Chat Button Test</h1>
    <p class="test-description">
      专门测试聊天按钮的定位、样式和功能
    </p>
    
    <div id="status-display" class="status-display info">
      正在初始化按钮测试...
    </div>
    
    <div class="test-controls">
      <button class="test-button" onclick="initWidget()">初始化 Widget</button>
      <button class="test-button" onclick="togglePosition()">切换位置</button>
      <button class="test-button" onclick="toggleTheme()">切换主题</button>
      <button class="test-button" onclick="toggleConnection()">模拟连接状态</button>
      <button class="test-button" onclick="addUnreadMessages()">添加未读消息</button>
      <button class="test-button" onclick="clearUnreadMessages()">清除未读消息</button>
      <button class="test-button" onclick="inspectButton()">检查按钮元素</button>
      <button class="test-button" onclick="testResponsive()">测试响应式</button>
    </div>
    
    <div class="test-info">
      <h3>测试检查项目：</h3>
      <ul>
        <li>✅ 按钮是否出现在正确位置（右下角/左下角）</li>
        <li>✅ 按钮是否保持固定定位（滚动时不移动）</li>
        <li>✅ 按钮样式是否正确渲染（颜色、渐变、阴影）</li>
        <li>✅ 悬停效果是否正常工作</li>
        <li>✅ 主题切换是否影响按钮样式</li>
        <li>✅ 未读消息徽章是否正确显示</li>
        <li>✅ 连接状态指示器是否正常</li>
        <li>✅ 移动端响应式是否正常</li>
      </ul>
    </div>
    
    <div id="debug-panel" class="debug-panel"></div>
  </div>
  
  <!-- 添加长内容来测试固定定位 -->
  <div class="content-area">
    滚动页面测试按钮固定定位
  </div>

  <script type="module">
    let widgetInitialized = false;
    let currentPosition = 'bottom-right';
    let currentTheme = 'light';
    let isConnected = true;
    let isConnecting = false;
    let unreadCount = 0;
    let chatWidget = null;

    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status-display');
      statusDiv.className = `status-display ${type}`;
      statusDiv.textContent = message;
    }

    function addDebugLog(message) {
      const debugPanel = document.getElementById('debug-panel');
      const timestamp = new Date().toLocaleTimeString();
      debugPanel.textContent += `[${timestamp}] ${message}\n`;
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    async function initWidget() {
      try {
        addDebugLog('开始初始化 Widget...');
        
        // 动态导入 Vue 组件
        const { createApp } = await import('http://localhost:3001/@modules/vue');
        const ChatWidget = await import('http://localhost:3001/src/components/ChatWidget.vue');
        
        addDebugLog('Vue 和 ChatWidget 组件已加载');
        
        // 创建 Vue 应用
        const app = createApp(ChatWidget.default, {
          config: {
            apiUrl: 'http://localhost:8080/api',
            websocketUrl: 'ws://localhost:8080/websocket',
            customerId: 'test_customer_' + Date.now(),
            customerName: '测试用户',
            theme: currentTheme,
            position: currentPosition
          }
        });
        
        // 创建挂载点
        let mountPoint = document.getElementById('widget-mount');
        if (!mountPoint) {
          mountPoint = document.createElement('div');
          mountPoint.id = 'widget-mount';
          mountPoint.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
          `;
          document.body.appendChild(mountPoint);
        }
        
        // 挂载应用
        chatWidget = app.mount(mountPoint);
        widgetInitialized = true;
        
        addDebugLog('Widget 挂载成功');
        updateStatus('✅ Widget 初始化成功！查看聊天按钮', 'success');
        
        // 检查按钮是否创建
        setTimeout(() => {
          inspectButton();
        }, 1000);
        
      } catch (error) {
        addDebugLog('初始化失败: ' + error.message);
        updateStatus('❌ 初始化失败: ' + error.message, 'error');
        console.error('Widget initialization error:', error);
      }
    }

    function togglePosition() {
      if (!widgetInitialized) {
        updateStatus('❌ 请先初始化 Widget', 'error');
        return;
      }
      
      currentPosition = currentPosition === 'bottom-right' ? 'bottom-left' : 'bottom-right';
      addDebugLog(`切换位置到: ${currentPosition}`);
      
      // 这里需要更新 Widget 的位置
      updateStatus(`✅ 位置已切换为: ${currentPosition}`, 'success');
    }

    function toggleTheme() {
      if (!widgetInitialized) {
        updateStatus('❌ 请先初始化 Widget', 'error');
        return;
      }
      
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      addDebugLog(`切换主题到: ${currentTheme}`);
      
      // 这里需要更新 Widget 的主题
      updateStatus(`✅ 主题已切换为: ${currentTheme}`, 'success');
    }

    function toggleConnection() {
      if (!widgetInitialized) {
        updateStatus('❌ 请先初始化 Widget', 'error');
        return;
      }
      
      if (isConnected) {
        isConnected = false;
        isConnecting = false;
      } else if (!isConnecting) {
        isConnecting = true;
      } else {
        isConnected = true;
        isConnecting = false;
      }
      
      const status = isConnecting ? '连接中' : (isConnected ? '已连接' : '已断开');
      addDebugLog(`连接状态: ${status}`);
      updateStatus(`✅ 连接状态: ${status}`, 'success');
    }

    function addUnreadMessages() {
      if (!widgetInitialized) {
        updateStatus('❌ 请先初始化 Widget', 'error');
        return;
      }
      
      unreadCount += Math.floor(Math.random() * 5) + 1;
      addDebugLog(`未读消息数: ${unreadCount}`);
      updateStatus(`✅ 未读消息数: ${unreadCount}`, 'success');
    }

    function clearUnreadMessages() {
      if (!widgetInitialized) {
        updateStatus('❌ 请先初始化 Widget', 'error');
        return;
      }
      
      unreadCount = 0;
      addDebugLog('已清除未读消息');
      updateStatus('✅ 已清除未读消息', 'success');
    }

    function inspectButton() {
      addDebugLog('=== 检查按钮元素 ===');
      
      const button = document.querySelector('.whisper-chat-button');
      if (!button) {
        addDebugLog('❌ 未找到聊天按钮元素');
        updateStatus('❌ 未找到聊天按钮', 'error');
        return;
      }
      
      addDebugLog('✅ 找到聊天按钮元素');
      
      // 检查样式
      const styles = window.getComputedStyle(button);
      addDebugLog(`位置: ${styles.position}`);
      addDebugLog(`z-index: ${styles.zIndex}`);
      addDebugLog(`bottom: ${styles.bottom}`);
      addDebugLog(`right: ${styles.right}`);
      addDebugLog(`left: ${styles.left}`);
      addDebugLog(`width: ${styles.width}`);
      addDebugLog(`height: ${styles.height}`);
      addDebugLog(`background: ${styles.background}`);
      addDebugLog(`border-radius: ${styles.borderRadius}`);
      
      // 检查类名
      addDebugLog(`类名: ${button.className}`);
      
      // 检查位置
      const rect = button.getBoundingClientRect();
      addDebugLog(`实际位置: top=${rect.top}, left=${rect.left}, right=${rect.right}, bottom=${rect.bottom}`);
      
      updateStatus('✅ 按钮检查完成，查看调试面板', 'success');
    }

    function testResponsive() {
      addDebugLog('=== 测试响应式设计 ===');
      
      const originalWidth = window.innerWidth;
      addDebugLog(`当前窗口宽度: ${originalWidth}px`);
      
      // 模拟移动端宽度
      if (originalWidth > 768) {
        addDebugLog('提示: 请手动调整浏览器窗口宽度到 < 768px 来测试移动端样式');
      } else {
        addDebugLog('当前处于移动端宽度，检查按钮样式...');
        setTimeout(inspectButton, 500);
      }
      
      updateStatus('✅ 响应式测试提示已输出', 'info');
    }

    // 页面加载完成后的初始化
    window.addEventListener('load', () => {
      addDebugLog('按钮测试页面已加载');
      updateStatus('🔄 页面已加载，点击"初始化 Widget"开始测试', 'info');
    });

    // 监听窗口大小变化
    window.addEventListener('resize', () => {
      addDebugLog(`窗口大小变化: ${window.innerWidth}x${window.innerHeight}`);
    });

    // 暴露函数到全局作用域
    window.initWidget = initWidget;
    window.togglePosition = togglePosition;
    window.toggleTheme = toggleTheme;
    window.toggleConnection = toggleConnection;
    window.addUnreadMessages = addUnreadMessages;
    window.clearUnreadMessages = clearUnreadMessages;
    window.inspectButton = inspectButton;
    window.testResponsive = testResponsive;
  </script>
</body>
</html>
