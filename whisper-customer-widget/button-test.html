<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Button Test - Whisper Widget</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      position: relative;
    }
    
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }
    
    .test-title {
      font-size: 2.5rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 1rem;
      color: #1f2937;
    }
    
    .test-description {
      font-size: 1.1rem;
      color: #6b7280;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .test-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .test-button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .test-button:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .test-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-display {
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-weight: 500;
    }
    
    .status-display.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    .status-display.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #f87171;
    }
    
    .status-display.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #60a5fa;
    }
    
    .debug-panel {
      background: #1f2937;
      color: #f3f4f6;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: monospace;
      font-size: 0.875rem;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .test-info {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .test-info h3 {
      margin: 0 0 0.5rem 0;
      color: #374151;
    }
    
    .test-info ul {
      margin: 0;
      padding-left: 1.5rem;
    }
    
    .test-info li {
      margin: 0.25rem 0;
      color: #6b7280;
    }
    
    /* Add some content to test positioning */
    .content-area {
      height: 200vh;
      background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0.3));
      margin: 2rem 0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1 class="test-title">ğŸ”˜ Chat Button Test</h1>
    <p class="test-description">
      ä¸“é—¨æµ‹è¯•èŠå¤©æŒ‰é’®çš„å®šä½ã€æ ·å¼å’ŒåŠŸèƒ½
    </p>
    
    <div id="status-display" class="status-display info">
      æ­£åœ¨åˆå§‹åŒ–æŒ‰é’®æµ‹è¯•...
    </div>
    
    <div class="test-controls">
      <button class="test-button" onclick="initWidget()">åˆå§‹åŒ– Widget</button>
      <button class="test-button" onclick="togglePosition()">åˆ‡æ¢ä½ç½®</button>
      <button class="test-button" onclick="toggleTheme()">åˆ‡æ¢ä¸»é¢˜</button>
      <button class="test-button" onclick="toggleConnection()">æ¨¡æ‹Ÿè¿æ¥çŠ¶æ€</button>
      <button class="test-button" onclick="addUnreadMessages()">æ·»åŠ æœªè¯»æ¶ˆæ¯</button>
      <button class="test-button" onclick="clearUnreadMessages()">æ¸…é™¤æœªè¯»æ¶ˆæ¯</button>
      <button class="test-button" onclick="inspectButton()">æ£€æŸ¥æŒ‰é’®å…ƒç´ </button>
      <button class="test-button" onclick="testResponsive()">æµ‹è¯•å“åº”å¼</button>
    </div>
    
    <div class="test-info">
      <h3>æµ‹è¯•æ£€æŸ¥é¡¹ç›®ï¼š</h3>
      <ul>
        <li>âœ… æŒ‰é’®æ˜¯å¦å‡ºç°åœ¨æ­£ç¡®ä½ç½®ï¼ˆå³ä¸‹è§’/å·¦ä¸‹è§’ï¼‰</li>
        <li>âœ… æŒ‰é’®æ˜¯å¦ä¿æŒå›ºå®šå®šä½ï¼ˆæ»šåŠ¨æ—¶ä¸ç§»åŠ¨ï¼‰</li>
        <li>âœ… æŒ‰é’®æ ·å¼æ˜¯å¦æ­£ç¡®æ¸²æŸ“ï¼ˆé¢œè‰²ã€æ¸å˜ã€é˜´å½±ï¼‰</li>
        <li>âœ… æ‚¬åœæ•ˆæœæ˜¯å¦æ­£å¸¸å·¥ä½œ</li>
        <li>âœ… ä¸»é¢˜åˆ‡æ¢æ˜¯å¦å½±å“æŒ‰é’®æ ·å¼</li>
        <li>âœ… æœªè¯»æ¶ˆæ¯å¾½ç« æ˜¯å¦æ­£ç¡®æ˜¾ç¤º</li>
        <li>âœ… è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨æ˜¯å¦æ­£å¸¸</li>
        <li>âœ… ç§»åŠ¨ç«¯å“åº”å¼æ˜¯å¦æ­£å¸¸</li>
      </ul>
    </div>
    
    <div id="debug-panel" class="debug-panel"></div>
  </div>
  
  <!-- æ·»åŠ é•¿å†…å®¹æ¥æµ‹è¯•å›ºå®šå®šä½ -->
  <div class="content-area">
    æ»šåŠ¨é¡µé¢æµ‹è¯•æŒ‰é’®å›ºå®šå®šä½
  </div>

  <script type="module">
    let widgetInitialized = false;
    let currentPosition = 'bottom-right';
    let currentTheme = 'light';
    let isConnected = true;
    let isConnecting = false;
    let unreadCount = 0;
    let chatWidget = null;

    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status-display');
      statusDiv.className = `status-display ${type}`;
      statusDiv.textContent = message;
    }

    function addDebugLog(message) {
      const debugPanel = document.getElementById('debug-panel');
      const timestamp = new Date().toLocaleTimeString();
      debugPanel.textContent += `[${timestamp}] ${message}\n`;
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    async function initWidget() {
      try {
        addDebugLog('å¼€å§‹åˆå§‹åŒ– Widget...');
        
        // åŠ¨æ€å¯¼å…¥ Vue ç»„ä»¶
        const { createApp } = await import('http://localhost:3001/@modules/vue');
        const ChatWidget = await import('http://localhost:3001/src/components/ChatWidget.vue');
        
        addDebugLog('Vue å’Œ ChatWidget ç»„ä»¶å·²åŠ è½½');
        
        // åˆ›å»º Vue åº”ç”¨
        const app = createApp(ChatWidget.default, {
          config: {
            apiUrl: 'http://localhost:8080/api',
            websocketUrl: 'ws://localhost:8080/websocket',
            customerId: 'test_customer_' + Date.now(),
            customerName: 'æµ‹è¯•ç”¨æˆ·',
            theme: currentTheme,
            position: currentPosition
          }
        });
        
        // åˆ›å»ºæŒ‚è½½ç‚¹
        let mountPoint = document.getElementById('widget-mount');
        if (!mountPoint) {
          mountPoint = document.createElement('div');
          mountPoint.id = 'widget-mount';
          mountPoint.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
          `;
          document.body.appendChild(mountPoint);
        }
        
        // æŒ‚è½½åº”ç”¨
        chatWidget = app.mount(mountPoint);
        widgetInitialized = true;
        
        addDebugLog('Widget æŒ‚è½½æˆåŠŸ');
        updateStatus('âœ… Widget åˆå§‹åŒ–æˆåŠŸï¼æŸ¥çœ‹èŠå¤©æŒ‰é’®', 'success');
        
        // æ£€æŸ¥æŒ‰é’®æ˜¯å¦åˆ›å»º
        setTimeout(() => {
          inspectButton();
        }, 1000);
        
      } catch (error) {
        addDebugLog('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        updateStatus('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        console.error('Widget initialization error:', error);
      }
    }

    function togglePosition() {
      if (!widgetInitialized) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Widget', 'error');
        return;
      }
      
      currentPosition = currentPosition === 'bottom-right' ? 'bottom-left' : 'bottom-right';
      addDebugLog(`åˆ‡æ¢ä½ç½®åˆ°: ${currentPosition}`);
      
      // è¿™é‡Œéœ€è¦æ›´æ–° Widget çš„ä½ç½®
      updateStatus(`âœ… ä½ç½®å·²åˆ‡æ¢ä¸º: ${currentPosition}`, 'success');
    }

    function toggleTheme() {
      if (!widgetInitialized) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Widget', 'error');
        return;
      }
      
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      addDebugLog(`åˆ‡æ¢ä¸»é¢˜åˆ°: ${currentTheme}`);
      
      // è¿™é‡Œéœ€è¦æ›´æ–° Widget çš„ä¸»é¢˜
      updateStatus(`âœ… ä¸»é¢˜å·²åˆ‡æ¢ä¸º: ${currentTheme}`, 'success');
    }

    function toggleConnection() {
      if (!widgetInitialized) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Widget', 'error');
        return;
      }
      
      if (isConnected) {
        isConnected = false;
        isConnecting = false;
      } else if (!isConnecting) {
        isConnecting = true;
      } else {
        isConnected = true;
        isConnecting = false;
      }
      
      const status = isConnecting ? 'è¿æ¥ä¸­' : (isConnected ? 'å·²è¿æ¥' : 'å·²æ–­å¼€');
      addDebugLog(`è¿æ¥çŠ¶æ€: ${status}`);
      updateStatus(`âœ… è¿æ¥çŠ¶æ€: ${status}`, 'success');
    }

    function addUnreadMessages() {
      if (!widgetInitialized) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Widget', 'error');
        return;
      }
      
      unreadCount += Math.floor(Math.random() * 5) + 1;
      addDebugLog(`æœªè¯»æ¶ˆæ¯æ•°: ${unreadCount}`);
      updateStatus(`âœ… æœªè¯»æ¶ˆæ¯æ•°: ${unreadCount}`, 'success');
    }

    function clearUnreadMessages() {
      if (!widgetInitialized) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Widget', 'error');
        return;
      }
      
      unreadCount = 0;
      addDebugLog('å·²æ¸…é™¤æœªè¯»æ¶ˆæ¯');
      updateStatus('âœ… å·²æ¸…é™¤æœªè¯»æ¶ˆæ¯', 'success');
    }

    function inspectButton() {
      addDebugLog('=== æ£€æŸ¥æŒ‰é’®å…ƒç´  ===');
      
      const button = document.querySelector('.whisper-chat-button');
      if (!button) {
        addDebugLog('âŒ æœªæ‰¾åˆ°èŠå¤©æŒ‰é’®å…ƒç´ ');
        updateStatus('âŒ æœªæ‰¾åˆ°èŠå¤©æŒ‰é’®', 'error');
        return;
      }
      
      addDebugLog('âœ… æ‰¾åˆ°èŠå¤©æŒ‰é’®å…ƒç´ ');
      
      // æ£€æŸ¥æ ·å¼
      const styles = window.getComputedStyle(button);
      addDebugLog(`ä½ç½®: ${styles.position}`);
      addDebugLog(`z-index: ${styles.zIndex}`);
      addDebugLog(`bottom: ${styles.bottom}`);
      addDebugLog(`right: ${styles.right}`);
      addDebugLog(`left: ${styles.left}`);
      addDebugLog(`width: ${styles.width}`);
      addDebugLog(`height: ${styles.height}`);
      addDebugLog(`background: ${styles.background}`);
      addDebugLog(`border-radius: ${styles.borderRadius}`);
      
      // æ£€æŸ¥ç±»å
      addDebugLog(`ç±»å: ${button.className}`);
      
      // æ£€æŸ¥ä½ç½®
      const rect = button.getBoundingClientRect();
      addDebugLog(`å®é™…ä½ç½®: top=${rect.top}, left=${rect.left}, right=${rect.right}, bottom=${rect.bottom}`);
      
      updateStatus('âœ… æŒ‰é’®æ£€æŸ¥å®Œæˆï¼ŒæŸ¥çœ‹è°ƒè¯•é¢æ¿', 'success');
    }

    function testResponsive() {
      addDebugLog('=== æµ‹è¯•å“åº”å¼è®¾è®¡ ===');
      
      const originalWidth = window.innerWidth;
      addDebugLog(`å½“å‰çª—å£å®½åº¦: ${originalWidth}px`);
      
      // æ¨¡æ‹Ÿç§»åŠ¨ç«¯å®½åº¦
      if (originalWidth > 768) {
        addDebugLog('æç¤º: è¯·æ‰‹åŠ¨è°ƒæ•´æµè§ˆå™¨çª—å£å®½åº¦åˆ° < 768px æ¥æµ‹è¯•ç§»åŠ¨ç«¯æ ·å¼');
      } else {
        addDebugLog('å½“å‰å¤„äºç§»åŠ¨ç«¯å®½åº¦ï¼Œæ£€æŸ¥æŒ‰é’®æ ·å¼...');
        setTimeout(inspectButton, 500);
      }
      
      updateStatus('âœ… å“åº”å¼æµ‹è¯•æç¤ºå·²è¾“å‡º', 'info');
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    window.addEventListener('load', () => {
      addDebugLog('æŒ‰é’®æµ‹è¯•é¡µé¢å·²åŠ è½½');
      updateStatus('ğŸ”„ é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»"åˆå§‹åŒ– Widget"å¼€å§‹æµ‹è¯•', 'info');
    });

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
      addDebugLog(`çª—å£å¤§å°å˜åŒ–: ${window.innerWidth}x${window.innerHeight}`);
    });

    // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.initWidget = initWidget;
    window.togglePosition = togglePosition;
    window.toggleTheme = toggleTheme;
    window.toggleConnection = toggleConnection;
    window.addUnreadMessages = addUnreadMessages;
    window.clearUnreadMessages = clearUnreadMessages;
    window.inspectButton = inspectButton;
    window.testResponsive = testResponsive;
  </script>
</body>
</html>
