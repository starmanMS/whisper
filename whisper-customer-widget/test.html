<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Whisper Chat Widget - 简单测试</title>
  <style>
    body {
      margin: 0;
      padding: 40px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .title {
      font-size: 2rem;
      margin-bottom: 20px;
      color: #333;
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-weight: 500;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .btn {
      padding: 12px 24px;
      margin: 8px;
      border: none;
      border-radius: 5px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover {
      background: #0056b3;
    }
    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">Whisper Chat Widget - 简单测试</h1>
    
    <div id="status-display">
      <div class="status info">正在加载 Widget...</div>
    </div>
    
    <div>
      <button class="btn" onclick="testWhisperChat()">测试 WhisperChat 对象</button>
      <button class="btn" onclick="initWidget()">初始化 Widget</button>
      <button class="btn" onclick="openChat()">打开聊天</button>
      <button class="btn" onclick="closeChat()">关闭聊天</button>
      <button class="btn" onclick="getState()">获取状态</button>
    </div>
    
    <div id="debug-info" class="debug-info"></div>
  </div>

  <!-- 引入 Widget CSS -->
  <link rel="stylesheet" href="./dist/style.css">

  <!-- 引入 Widget JS -->
  <script src="./dist/whisper-chat-widget.umd.cjs"></script>

  <script>
    let widgetInitialized = false;

    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status-display');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function updateDebugInfo(info) {
      const debugDiv = document.getElementById('debug-info');
      const timestamp = new Date().toLocaleTimeString();
      debugDiv.textContent += `[${timestamp}] ${info}\n`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    function testWhisperChat() {
      updateDebugInfo('Testing WhisperChat object...');
      
      if (typeof WhisperChat === 'undefined') {
        updateStatus('❌ WhisperChat 未定义', 'error');
        updateDebugInfo('ERROR: WhisperChat is undefined');
        return;
      }

      updateStatus('✅ WhisperChat 对象已加载', 'success');
      updateDebugInfo('SUCCESS: WhisperChat object is available');
      updateDebugInfo('WhisperChat type: ' + typeof WhisperChat);
      updateDebugInfo('WhisperChat methods: ' + Object.getOwnPropertyNames(WhisperChat).join(', '));
      
      // 测试静态方法
      try {
        const version = WhisperChat.constructor.getVersion();
        updateDebugInfo('Version: ' + version);
      } catch (e) {
        updateDebugInfo('Version check failed: ' + e.message);
      }

      try {
        const compatibility = WhisperChat.constructor.checkCompatibility();
        updateDebugInfo('Browser compatibility: ' + compatibility);
      } catch (e) {
        updateDebugInfo('Compatibility check failed: ' + e.message);
      }
    }

    function initWidget() {
      updateDebugInfo('Initializing widget...');
      
      if (typeof WhisperChat === 'undefined') {
        updateStatus('❌ WhisperChat 未加载', 'error');
        updateDebugInfo('ERROR: WhisperChat not loaded');
        return;
      }

      if (widgetInitialized) {
        updateStatus('⚠️ Widget 已经初始化', 'info');
        updateDebugInfo('WARNING: Widget already initialized');
        return;
      }

      try {
        WhisperChat.init({
          apiUrl: 'http://localhost:8080/api',
          websocketUrl: 'ws://localhost:8080/websocket',
          customerId: 'test_customer_' + Date.now(),
          customerName: '测试用户',
          theme: 'light',
          position: 'bottom-right'
        });

        widgetInitialized = true;
        updateStatus('✅ Widget 初始化成功！', 'success');
        updateDebugInfo('SUCCESS: Widget initialized');
        
        // 检查是否有聊天按钮出现
        setTimeout(() => {
          const chatButton = document.querySelector('.whisper-chat-button');
          if (chatButton) {
            updateDebugInfo('SUCCESS: Chat button found in DOM');
          } else {
            updateDebugInfo('WARNING: Chat button not found in DOM');
          }
        }, 1000);

      } catch (error) {
        updateStatus('❌ Widget 初始化失败：' + error.message, 'error');
        updateDebugInfo('ERROR: ' + error.message);
        console.error('Widget initialization error:', error);
      }
    }

    function openChat() {
      updateDebugInfo('Opening chat...');
      
      if (!widgetInitialized) {
        updateStatus('❌ 请先初始化 Widget', 'error');
        updateDebugInfo('ERROR: Widget not initialized');
        return;
      }

      try {
        WhisperChat.open();
        updateStatus('✅ 聊天对话框已打开', 'success');
        updateDebugInfo('SUCCESS: Chat dialog opened');
      } catch (error) {
        updateStatus('❌ 打开聊天失败：' + error.message, 'error');
        updateDebugInfo('ERROR: ' + error.message);
      }
    }

    function closeChat() {
      updateDebugInfo('Closing chat...');
      
      if (!widgetInitialized) {
        updateStatus('❌ 请先初始化 Widget', 'error');
        updateDebugInfo('ERROR: Widget not initialized');
        return;
      }

      try {
        WhisperChat.close();
        updateStatus('✅ 聊天对话框已关闭', 'info');
        updateDebugInfo('SUCCESS: Chat dialog closed');
      } catch (error) {
        updateStatus('❌ 关闭聊天失败：' + error.message, 'error');
        updateDebugInfo('ERROR: ' + error.message);
      }
    }

    function getState() {
      updateDebugInfo('Getting widget state...');
      
      if (!widgetInitialized) {
        updateStatus('❌ 请先初始化 Widget', 'error');
        updateDebugInfo('ERROR: Widget not initialized');
        return;
      }

      try {
        const state = WhisperChat.getState();
        updateStatus('✅ 状态获取成功', 'success');
        updateDebugInfo('Widget state: ' + JSON.stringify(state, null, 2));
      } catch (error) {
        updateStatus('❌ 获取状态失败：' + error.message, 'error');
        updateDebugInfo('ERROR: ' + error.message);
      }
    }

    // 页面加载完成后的检查
    window.addEventListener('load', () => {
      updateDebugInfo('Page loaded');
      
      setTimeout(() => {
        if (typeof WhisperChat !== 'undefined') {
          updateStatus('✅ WhisperChat 已加载，可以开始测试', 'success');
          updateDebugInfo('WhisperChat loaded successfully');
          testWhisperChat();
        } else {
          updateStatus('❌ WhisperChat 加载失败', 'error');
          updateDebugInfo('ERROR: WhisperChat failed to load');
        }
      }, 100);
    });

    // 监听错误
    window.addEventListener('error', (event) => {
      updateDebugInfo('JavaScript Error: ' + event.error.message);
      updateStatus('❌ JavaScript 错误：' + event.error.message, 'error');
    });

    // 监听未处理的Promise拒绝
    window.addEventListener('unhandledrejection', (event) => {
      updateDebugInfo('Unhandled Promise Rejection: ' + event.reason);
      updateStatus('❌ Promise 错误：' + event.reason, 'error');
    });
  </script>
</body>
</html>
