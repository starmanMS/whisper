<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Whisper Chat Widget - å¼€å‘æµ‹è¯•</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .test-container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 48px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
    }
    
    .test-title {
      font-size: 3rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 1rem;
      color: #1f2937;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .test-description {
      font-size: 1.2rem;
      line-height: 1.7;
      color: #6b7280;
      text-align: center;
      margin-bottom: 3rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .test-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }
    
    .test-button {
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .test-button.primary {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      transform: translateY(0);
    }
    
    .test-button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    
    .test-button.secondary {
      background: #f8fafc;
      color: #374151;
      border: 2px solid #e2e8f0;
    }
    
    .test-button.secondary:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
      transform: translateY(-1px);
    }
    
    .status-display {
      margin: 2rem 0;
      padding: 1rem;
      border-radius: 12px;
      font-weight: 500;
      text-align: center;
    }
    
    .status-display.success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    .status-display.error {
      background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);
      color: #991b1b;
      border: 1px solid #f87171;
    }
    
    .status-display.info {
      background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
      color: #1e40af;
      border: 1px solid #60a5fa;
    }
    
    .debug-panel {
      background: #1f2937;
      color: #f3f4f6;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .highlight-box {
      background: #fef3c7;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #f59e0b;
      margin: 20px 0;
    }
    
    @media (max-width: 768px) {
      .test-container {
        margin: 10px;
        padding: 24px;
      }
      
      .test-title {
        font-size: 2rem;
      }
      
      .test-description {
        font-size: 1rem;
      }
      
      .test-buttons {
        flex-direction: column;
        align-items: center;
      }
      
      .test-button {
        width: 100%;
        max-width: 300px;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1 class="test-title">ğŸš€ Whisper Chat Widget</h1>
    <p class="test-description">
      å¼€å‘æ¨¡å¼æµ‹è¯•é¡µé¢ - éªŒè¯æ ·å¼å’ŒåŠŸèƒ½<br>
      <strong>å¼€å‘æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:3002</strong>
    </p>
    
    <div id="status-display" class="status-display info">
      æ­£åœ¨è¿æ¥å¼€å‘æœåŠ¡å™¨...
    </div>
    
    <div class="test-buttons">
      <button class="test-button primary" onclick="testConnection()">
        ğŸ”— æµ‹è¯•è¿æ¥
      </button>
      <button class="test-button primary" onclick="initWidget()">
        ğŸ¯ åˆå§‹åŒ– Widget
      </button>
      <button class="test-button secondary" onclick="openWidget()">
        ğŸ’¬ æ‰“å¼€èŠå¤©
      </button>
      <button class="test-button secondary" onclick="toggleTheme()">
        ğŸŒ™ åˆ‡æ¢ä¸»é¢˜
      </button>
      <button class="test-button secondary" onclick="togglePosition()">
        ğŸ“ åˆ‡æ¢ä½ç½®
      </button>
      <button class="test-button secondary" onclick="getWidgetState()">
        ğŸ“Š è·å–çŠ¶æ€
      </button>
    </div>
    
    <div class="highlight-box">
      <strong>å¼€å‘æ¨¡å¼è¯´æ˜ï¼š</strong><br>
      1. ç¡®ä¿å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (npm run dev)<br>
      2. ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯å¼€å‘æœåŠ¡å™¨çŠ¶æ€<br>
      3. ç‚¹å‡»"åˆå§‹åŒ– Widget"åˆ›å»ºèŠå¤©ç»„ä»¶<br>
      4. æŸ¥çœ‹å³ä¸‹è§’æ˜¯å¦å‡ºç°èŠå¤©æŒ‰é’®<br>
      5. ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹æ ·å¼å’Œæ§åˆ¶å°æ—¥å¿—
    </div>
    
    <div id="debug-panel" class="debug-panel"></div>
  </div>

  <script>
    let widgetInitialized = false;
    let currentTheme = 'light';
    let currentPosition = 'bottom-right';

    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status-display');
      statusDiv.className = `status-display ${type}`;
      statusDiv.textContent = message;
    }

    function addDebugLog(message) {
      const debugPanel = document.getElementById('debug-panel');
      const timestamp = new Date().toLocaleTimeString();
      debugPanel.textContent += `[${timestamp}] ${message}\n`;
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    function testConnection() {
      addDebugLog('Testing connection to development server...');
      
      fetch('http://localhost:3002/')
        .then(response => {
          if (response.ok) {
            updateStatus('âœ… å¼€å‘æœåŠ¡å™¨è¿æ¥æˆåŠŸ', 'success');
            addDebugLog('Development server is running and accessible');
            
            // å°è¯•åŠ è½½ Widget è„šæœ¬
            loadWidgetScript();
          } else {
            updateStatus('âŒ å¼€å‘æœåŠ¡å™¨å“åº”å¼‚å¸¸', 'error');
            addDebugLog('Development server responded with error: ' + response.status);
          }
        })
        .catch(error => {
          updateStatus('âŒ æ— æ³•è¿æ¥åˆ°å¼€å‘æœåŠ¡å™¨', 'error');
          addDebugLog('Failed to connect to development server: ' + error.message);
        });
    }

    function loadWidgetScript() {
      addDebugLog('Loading Widget script from development server...');
      
      // åŠ¨æ€åŠ è½½å¼€å‘æœåŠ¡å™¨çš„è„šæœ¬
      const script = document.createElement('script');
      script.type = 'module';
      script.src = 'http://localhost:3002/src/main.js';
      script.onload = () => {
        addDebugLog('Widget script loaded successfully');
        updateStatus('âœ… Widget è„šæœ¬å·²åŠ è½½', 'success');
        
        // æ£€æŸ¥ WhisperChat æ˜¯å¦å¯ç”¨
        setTimeout(() => {
          if (typeof window.WhisperChat !== 'undefined') {
            addDebugLog('WhisperChat object is available');
            updateStatus('âœ… WhisperChat å¯¹è±¡å·²å°±ç»ª', 'success');
          } else {
            addDebugLog('WhisperChat object not found');
            updateStatus('âš ï¸ WhisperChat å¯¹è±¡æœªæ‰¾åˆ°', 'error');
          }
        }, 1000);
      };
      script.onerror = () => {
        addDebugLog('Failed to load Widget script');
        updateStatus('âŒ Widget è„šæœ¬åŠ è½½å¤±è´¥', 'error');
      };
      
      document.head.appendChild(script);
    }

    function initWidget() {
      addDebugLog('Initializing Widget...');
      
      if (typeof window.WhisperChat === 'undefined') {
        updateStatus('âŒ WhisperChat æœªåŠ è½½ï¼Œè¯·å…ˆæµ‹è¯•è¿æ¥', 'error');
        addDebugLog('WhisperChat object not available');
        return;
      }

      if (widgetInitialized) {
        updateStatus('âš ï¸ Widget å·²ç»åˆå§‹åŒ–', 'info');
        addDebugLog('Widget already initialized');
        return;
      }

      try {
        window.WhisperChat.init({
          apiUrl: 'http://localhost:8080/api',
          websocketUrl: 'ws://localhost:8080/websocket',
          customerId: 'dev_customer_' + Date.now(),
          customerName: 'å¼€å‘æµ‹è¯•ç”¨æˆ·',
          theme: currentTheme,
          position: currentPosition
        });
        
        widgetInitialized = true;
        updateStatus('âœ… Widget åˆå§‹åŒ–æˆåŠŸï¼æŸ¥çœ‹å³ä¸‹è§’', 'success');
        addDebugLog('Widget initialized successfully');
        
        // æ£€æŸ¥èŠå¤©æŒ‰é’®æ˜¯å¦åˆ›å»º
        setTimeout(() => {
          const chatButton = document.querySelector('.whisper-chat-button');
          if (chatButton) {
            addDebugLog('Chat button found in DOM');
            updateStatus('âœ… èŠå¤©æŒ‰é’®å·²åˆ›å»ºå¹¶æ˜¾ç¤º', 'success');
          } else {
            addDebugLog('Chat button not found in DOM');
            updateStatus('âš ï¸ èŠå¤©æŒ‰é’®æœªæ‰¾åˆ°', 'error');
          }
        }, 1000);

      } catch (error) {
        updateStatus('âŒ Widget åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message, 'error');
        addDebugLog('Widget initialization failed: ' + error.message);
        console.error('Widget initialization error:', error);
      }
    }

    function openWidget() {
      if (!widgetInitialized) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Widget', 'error');
        return;
      }
      
      try {
        window.WhisperChat.open();
        updateStatus('âœ… èŠå¤©å¯¹è¯æ¡†å·²æ‰“å¼€', 'success');
        addDebugLog('Chat dialog opened');
      } catch (error) {
        updateStatus('âŒ æ‰“å¼€å¤±è´¥: ' + error.message, 'error');
        addDebugLog('Failed to open chat: ' + error.message);
      }
    }

    function toggleTheme() {
      if (!widgetInitialized) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Widget', 'error');
        return;
      }
      
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      try {
        window.WhisperChat.setTheme(currentTheme);
        updateStatus(`âœ… ä¸»é¢˜å·²åˆ‡æ¢ä¸º: ${currentTheme}`, 'success');
        addDebugLog(`Theme changed to: ${currentTheme}`);
      } catch (error) {
        updateStatus('âŒ åˆ‡æ¢ä¸»é¢˜å¤±è´¥: ' + error.message, 'error');
        addDebugLog('Failed to change theme: ' + error.message);
      }
    }

    function togglePosition() {
      if (!widgetInitialized) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Widget', 'error');
        return;
      }
      
      currentPosition = currentPosition === 'bottom-right' ? 'bottom-left' : 'bottom-right';
      try {
        window.WhisperChat.setPosition(currentPosition);
        updateStatus(`âœ… ä½ç½®å·²åˆ‡æ¢ä¸º: ${currentPosition}`, 'success');
        addDebugLog(`Position changed to: ${currentPosition}`);
      } catch (error) {
        updateStatus('âŒ åˆ‡æ¢ä½ç½®å¤±è´¥: ' + error.message, 'error');
        addDebugLog('Failed to change position: ' + error.message);
      }
    }

    function getWidgetState() {
      if (!widgetInitialized) {
        updateStatus('âŒ è¯·å…ˆåˆå§‹åŒ– Widget', 'error');
        return;
      }
      
      try {
        const state = window.WhisperChat.getState();
        console.log('Widget State:', state);
        updateStatus('âœ… çŠ¶æ€å·²è¾“å‡ºåˆ°æ§åˆ¶å°', 'success');
        addDebugLog('Widget state: ' + JSON.stringify(state, null, 2));
      } catch (error) {
        updateStatus('âŒ è·å–çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
        addDebugLog('Failed to get state: ' + error.message);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•è¿æ¥
    window.addEventListener('load', () => {
      addDebugLog('Development test page loaded');
      updateStatus('ğŸ”„ é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»"æµ‹è¯•è¿æ¥"å¼€å§‹', 'info');
    });

    // ç›‘å¬é”™è¯¯
    window.addEventListener('error', (event) => {
      console.error('JavaScript Error:', event.error);
      addDebugLog('JavaScript Error: ' + event.error.message);
      updateStatus('âŒ JavaScript é”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
    });

    // ç›‘å¬æœªå¤„ç†çš„Promiseæ‹’ç»
    window.addEventListener('unhandledrejection', (event) => {
      addDebugLog('Unhandled Promise Rejection: ' + event.reason);
      updateStatus('âŒ Promise é”™è¯¯ï¼š' + event.reason, 'error');
    });
  </script>
</body>
</html>
